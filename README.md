# Сервис Сегментации Пользователей

## Содержание

- [Введение](#введение)
- [Начало работы](#начало-работы)
    - [Установка](#установка)
    - [Использование](#использование)
- [Эндпоинты](#эндпоинты)
    - [Создание Сегмента](#создание-сегмента)
    - [Удаление Сегмента](#удаление-сегмента)
    - [Изменение Сегментов Пользователя](#изменение-сегментов-пользователя)
    - [Получение Активных Сегментов Пользователя](#получение-активных-сегментов-пользователя)
    - [Получение Ссылки на CSV Отчет](#получение-ссылки-на-csv-отчет)

## Введение
Этот проект представляет собой практическое задание, необходимое для отбора на стажировку в компанию Avito. 
В рамках этого задания требовалось разработать инструмент для эффективного управления сегментами пользователей. 
Этот инструмент позволяет категоризировать и настраивать взаимодействие с пользователями на основе разнообразных критериев. 
Кроме того, проект предполагает создание механизма для формирования отчетов об изменениях в сегментах пользователей.

## Начало работы

### Установка

Перед началом убедитесь, что у вас выполнены следующие предварительные требования:

- Docker (для контейниризации)
- Docker Compose

Для настройки сервиса выполните следующие шаги:

1. Склонируйте этот репозиторий.
2. Перейдите в каталог проекта.
3. При необходимости отредактируйте конфигурационные файлы (config/config.yaml и .env).
4. Выполните следующую команду для запуска сервиса:

   ```bash
   docker-compose up --build -d
   ```

### Использование

Чтобы взаимодействовать с сервисом, вы можете использовать различные API-эндпоинты, как описано в разделе [Эндпоинты](#эндпоинты). 
Кроме того, предварительно заполненные конфигурационные файлы (config/config.yaml и .env) предоставляются для ускорения процесса тестирования. 
Если требуется внести изменения в настройки, не стесняйтесь редактировать эти файлы.

Для доступа к API используются API KEY, которыми можно управлять через командную строку с помощью следующих команд:

- Для создания нового API KEY:
  ```bash
  docker exec -it app ./apikey generate
  ```
- Для проверки существования API KEY:
  ```bash
  docker exec -it app ./apikey exist <token>
  ```

Для просмотра возможностей, создан файл [example.http](example.http), запускайте команды по очереди. 
В нем не все примеры ситуация, но написанные в нем запросы сделают проверку проекта проще.

## Эндпоинты

### Создание Сегмента

Эндпоинт для создания сегмента пользователей. Поддерживает дополнительную опцию `percentageUsers`, которая 
автоматически включит определенный процент пользователей в сегмент (10000 == 100%). 
В истории для автоматически добавленных пользователей будет указан тип события "auto_add".

#### Запрос для создания сегмента

```http request
POST /api/v1/segments/create
Content-Type: application/json
Authorization: Bearer <token>

{
  "slug": "AVITO_DISCOUNT_30"
}
```

#### Запрос для создания сегмента с дополнительной опцией

```http request
POST /api/v1/segments/create
Content-Type: application/json
Authorization: Bearer <token>

{
  "slug": "AVITO_DISCOUNT_30",
  "percentageUsers": 10000
}
```

#### Ответ

```json
{
  "slug": "AVITO_DISCOUNT_30"
}
```

### Удаление Сегмента

Эндпоинт для удаления сегмента. При удалении сегмента, из него выбывают все пользователи. 
В истории для удаленных пользователей будет указан тип события `delete_segment`.

#### Запрос для удаления сегмента

```http request
DELETE /api/v1/segments/delete
Content-Type: application/json
Authorization: Bearer <token>

{
  "slug": "AVITO_DISCOUNT_30"
}
```

#### Ответ

```
<Response body is empty>
```

### Изменение Сегментов Пользователя

Этот метод, выполненный согласно поставленной задаче, обеспечивает внесение и удаление сегментов пользователя. 
Если один из сегментов в разделе `segments_add` не существует, запрос завершится ошибкой. Это поведение не относится к разделу `segments_del`.
В истории, добавление сегмента помечается как "add", а удаление как "del".

Запись истории учитывает неправильные операции и не фиксирует такие изменения. 
К примеру, если производится попытка удаления пользователя из сегмента, в котором он не числится.

#### Запрос для изменения сегментов

```http request
POST /api/v1/users/segments
Content-Type: application/json
Authorization: Bearer <token>

{
  "user_id": "<user_id>",
  "segments_add": [
    "AVITO_DISCOUNT_AUTO",
    "AVITO_PERFORMANCE_VAS"
  ],
    "segments_del": [
    "AVITO_OLD"
  ]
}
```

#### Ответ

```
<Response body is empty>
```

### Получение Активных Сегментов Пользователя

Этот метод позволяет получить список сегментов, в которых находится конкретный пользователь. 
Для этого необходимо выполнить GET запрос, передав ID пользователя в качестве аргумента URL.

#### Запрос для получения сегментов пользователя

```http request
GET /api/v1/users/active-segments?user_id=<user_id>
Content-Type: application/json
Authorization: Bearer <token>
```

#### Ответ

```json
{
  "user_id": "<user_id>",
  "segments": [
    "AVITO_DISCOUNT_AUTO",
    "AVITO_PERFORMANCE_VAS"
  ]
}
```

### Получение Ссылки на CSV Отчет

Этот метод предоставляет ссылку на CSV-отчет о пользователе за определенный месяц и год. 
Полученная ссылка всегда остается действительной, и отчет можно скачивать без использования API KEY.

#### Запрос для получения ссылки на отчет

```http request
POST /api/v1/history/report-link
Content-Type: application/json
Authorization: Bearer <token>

{
  "user_id": "<user_id>",
  "year": 2023,
  "month": 8
}
```

#### Ответ

```json
{
  "user_id": "b2c03a4c-4409-11ee-be56-0242ac120011",
  "report_link": "http://localhost:8080/reports/b2c03a4c-4409-11ee-be56-0242ac120011-2023-8-1693231794.csv"
}
```

#### Пример отчета по ссылке `report_link`

```csv
UserID,SegmentSlug,Type,CreatedAt
b2c03a4c-4409-11ee-be56-0242ac120011,AVITO_DISCOUNT_AUTO,add,2023-08-28 13:42:45.336724 +0000 UTC
b2c03a4c-4409-11ee-be56-0242ac120011,AVITO_PERFORMANCE_VAS,add,2023-08-28 13:58:17.369431 +0000 UTC
```